#!/usr/bin/env sh

(
    tear_down() {
        trap - TERM
        kill -- -$$
    }
    trap "tear_down" INT TERM EXIT

    cd `dirname "$0"`/..
    uwsgi --http-socket 0.0.0.0:5000 -p 2 --manage-script-name --mount /=alfred_http.flask.entry_point:app &
    sleep 3
    flake8 --ignore=E501 ./alfred
    flake8 --ignore=E501 ./alfred_http
    flake8 --ignore=E501 ./alfred_manor
    flake8 --ignore=E501 ./alfred_openapi
    flake8 --ignore=E501 ./alfred_rest
    coverage run -m nose2 &&
    coverage report -m
)
