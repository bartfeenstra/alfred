#!/usr/bin/env bash

(
    tear_down() {
        trap - INT TERM EXIT
        kill -- -$$
    }
    trap "tear_down" INT TERM EXIT

    cd `dirname "$0"`/..
    uwsgi --http-socket 0.0.0.0:5000 -p 2 --manage-script-name --mount /=alfred_http.flask.entry_point:app &
    sleep 3

    # Aggregate test exit codes.
    exit_code=0
    trap '(( exit_code |= $? ))' ERR

    flake8 --ignore=E501 ./alfred
    flake8 --ignore=E501 ./alfred_http
    flake8 --ignore=E501 ./alfred_manor
    flake8 --ignore=E501 ./alfred_openapi
    flake8 --ignore=E501 ./alfred_rest
    coverage run -m nose2
    coverage report -m

    # Trigger tear-down explicitly, so the traps are removed, and we can exit
    # with the aggregated test exit code.
    tear_down
    exit $exit_code
)
